<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Annotated Example: Two-Point Correlator &mdash; corrfitter 4.1 documentation</title>
    
    <link rel="stylesheet" href="_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="corrfitter 4.1 documentation" href="index.html" />
    <link rel="next" title="Annotated Example: Transition Form Factor" href="example-etas-Ds.html" />
    <link rel="prev" title="corrfitter - Least-Squares Fit to Correlators" href="corrfitter.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example-etas-Ds.html" title="Annotated Example: Transition Form Factor"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="corrfitter.html" title="corrfitter - Least-Squares Fit to Correlators"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">corrfitter 4.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="annotated-example-two-point-correlator">
<h1>Annotated Example: Two-Point Correlator<a class="headerlink" href="#annotated-example-two-point-correlator" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The simplest use of <a class="reference internal" href="corrfitter.html#module-corrfitter" title="corrfitter: Least-Squares Fit to Correlators."><tt class="xref py py-mod docutils literal"><span class="pre">corrfitter</span></tt></a> is calculating the
amplitude and energy of the ground state in a single
two-point correlator. Here we analyze an <img class="math" src="_images/math/fc10e978f762ea5b244f6011ea326b9325eb4396.png" alt="\eta_s" style="vertical-align: -3px"/> propagator where the
source and sink are the same.</p>
<p>The one slightly non-obvious aspect of this fit is its use of
log-normal priors for the energy differences <tt class="docutils literal"><span class="pre">dE</span></tt> between successive
states in the correlator. As discussed in <a class="reference internal" href="corrfitter.html#positive-parameters"><em>Faster Fits &#8212; Postive Parameters</em></a>,
this choice imposes an order on the states in relation to the
fit parameters by forcing all <tt class="docutils literal"><span class="pre">dE</span></tt> values to be positive.
Any such restriction helps stabilize a fit, improving both
efficiency and the final results.</p>
<p>Another design option that  helps stabilize the fit is to do a series of
fits, with increasing  number <tt class="docutils literal"><span class="pre">N</span></tt> of states in the fit function, where
the results  from the <tt class="docutils literal"><span class="pre">N-1</span></tt> fit are used by the fitter as the  starting
point (<tt class="docutils literal"><span class="pre">p0</span></tt>) for the <tt class="docutils literal"><span class="pre">N</span></tt> fit. The initial fits are bad, but this procedure
helps guide the fit parameters towards sensible values as the number of states
increases. See <a class="reference internal" href="corrfitter.html#faster-fits"><em>Faster Fits</em></a> for more discussion.</p>
<p>The source code (<tt class="docutils literal"><span class="pre">etas.py</span></tt>) and
data file (<tt class="docutils literal"><span class="pre">etas-Ds.data</span></tt>) are included with the <a class="reference internal" href="corrfitter.html#module-corrfitter" title="corrfitter: Least-Squares Fit to Correlators."><tt class="xref py py-mod docutils literal"><span class="pre">corrfitter</span></tt></a>
distribution, in the <tt class="docutils literal"><span class="pre">examples/</span></tt> directory.
The data are from the HPQCD collaboration.</p>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<p>Following the template outlined in <a class="reference internal" href="corrfitter.html#basic-fits"><em>Basic Fits</em></a>, the entire
code is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>   <span class="c"># makes this work for python2 and 3</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">gvar</span> <span class="kn">as</span> <span class="nn">gv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">corrfitter</span> <span class="kn">import</span> <span class="n">CorrFitter</span><span class="p">,</span> <span class="n">Corr2</span><span class="p">,</span> <span class="n">read_dataset</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">make_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;etas-Ds.data&#39;</span><span class="p">)</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">CorrFitter</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="n">make_models</span><span class="p">())</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>                                   
        <span class="k">print</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;nterm =&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">lsqfit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>  
        <span class="n">p0</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">pmean</span>    
        <span class="n">print_results</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>                                  

<span class="k">def</span> <span class="nf">make_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read data, compute averages/covariance matrix for G(t). &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">gv</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">avg_data</span><span class="p">(</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_models</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Create corrfitter model for G(t). &quot;&quot;&quot;</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">Corr2</span><span class="p">(</span>
        <span class="n">datatag</span><span class="o">=</span><span class="s">&#39;etas&#39;</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">tdata</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">tfit</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="mi">5</span><span class="p">),</span> 
        <span class="n">a</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">dE</span><span class="o">=</span><span class="s">&#39;dE&#39;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">corr</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">make_prior</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create prior for N-state fit. &quot;&quot;&quot;</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">prior</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="p">[</span><span class="s">&#39;0(1)&#39;</span><span class="p">])</span>
    <span class="n">prior</span><span class="p">[</span><span class="s">&#39;logdE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="p">[</span><span class="s">&#39;0.5(5)&#39;</span><span class="p">]))</span>                       
    <span class="k">return</span> <span class="n">prior</span>

<span class="k">def</span> <span class="nf">print_results</span><span class="p">(</span><span class="n">fit</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">transformed_p</span>                               
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;dE&#39;</span><span class="p">])</span>                              
        <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span>                                          
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{:2}  {:15}  {:15}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;E&#39;</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> 
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{:2}  {:15}  {:15}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Here the Monte Carlo data are read by <tt class="docutils literal"><span class="pre">make_data('etas-Ds.data')</span></tt>  from file
<tt class="docutils literal"><span class="pre">'etas-Ds.data'</span></tt>. This file contains (among other things)  225 lines,  each
with 64 numbers, of the form:</p>
<div class="highlight-python"><div class="highlight"><pre>etas    0.305044    0.0789607   0.0331313 ...
etas    0.306573    0.0802435   0.0340765 ...
...
</pre></div>
</div>
<p>Each line is a different Monte Carlo estimate of the <img class="math" src="_images/math/fc10e978f762ea5b244f6011ea326b9325eb4396.png" alt="\eta_s" style="vertical-align: -3px"/>
correlator for t=0...63. The mean values and covariance matrix
are computed for the 64 elements of the correlator using
<tt class="xref py py-func docutils literal"><span class="pre">gvar.dataset.avg_data()</span></tt>, and the result is stored in
<tt class="docutils literal"><span class="pre">data['etas']</span></tt>, which is an array of Gaussian random
variables (objects of type <tt class="xref py py-class docutils literal"><span class="pre">gvar.GVar</span></tt>).</p>
<p>A <a class="reference internal" href="corrfitter.html#corrfitter.CorrFitter" title="corrfitter.CorrFitter"><tt class="xref py py-class docutils literal"><span class="pre">corrfitter.CorrFitter</span></tt></a> object, <tt class="docutils literal"><span class="pre">fitter</span></tt>, is created for a single two-point
correlator from a list of models created by <tt class="docutils literal"><span class="pre">make_models()</span></tt>. There
is only one model in the list because there is only one correlator.
It is a <tt class="xref py py-class docutils literal"><span class="pre">Corr2</span></tt> object which specifies that:
the key (<tt class="docutils literal"><span class="pre">datatag</span></tt>) for extracting the correlator from the data dictionary is
<tt class="docutils literal"><span class="pre">'etas'</span></tt>; the propagator is periodic with period 64; each correlator
contains data for t values ranging from 0 to 63; only values
greater than or equal to 5 and less than 64-5 are fit; the
source and sink amplitudes are the same and labeled by <tt class="docutils literal"><span class="pre">'a'</span></tt> in
the prior; and the energy differences between successive states
are labeled <tt class="docutils literal"><span class="pre">'dE'</span></tt> in the prior.</p>
<p>Fits are tried with <tt class="docutils literal"><span class="pre">N</span></tt> states in the fit function, where <tt class="docutils literal"><span class="pre">N</span></tt>
varies from 2 to 5. Usually <tt class="docutils literal"><span class="pre">N=2</span></tt> is too small, resulting in
a poor fit. Here we will find that results have converged by
<tt class="docutils literal"><span class="pre">N=3</span></tt>.</p>
<p>A prior, containing <em>a priori</em> estimates for the fit parameters,
is contructed for each <tt class="docutils literal"><span class="pre">N</span></tt> by <tt class="docutils literal"><span class="pre">make_prior(N)</span></tt>. The amplitude priors,
<tt class="docutils literal"><span class="pre">prior['a'][i]</span></tt>,
are assumed to be 0±1, while the differences between successive
energies are taken to be, roughly, 0.5±0.5. These are broad priors,
based upon preliminary fits of the data.
We want to use log-normal
statistics for the energy differences, to guarantee that
they are positive (and the states ordered, in order of
increasing energy), so we use <tt class="docutils literal"><span class="pre">prior['logdE']</span></tt> for
the logarithms of the differences &#8212; instead of
<tt class="docutils literal"><span class="pre">prior['dE']</span></tt> for the differences themselves &#8212; and take the logarithm
of the prior.</p>
<p>The fit is done by <tt class="docutils literal"><span class="pre">fitter.lsqfit()</span></tt> and
<tt class="docutils literal"><span class="pre">print_results(fit)</span></tt> prints results for the first two states after
each fit (that is, for each <tt class="docutils literal"><span class="pre">N</span></tt>). Note how results from
the fit to <tt class="docutils literal"><span class="pre">N</span></tt> terms is used as the starting point for the
fit with <tt class="docutils literal"><span class="pre">N+1</span></tt> terms, via parameter <tt class="docutils literal"><span class="pre">p0</span></tt>. As mentioned above,
this speeds up the larger fits and also helps to stabilize them.</p>
</div>
<div class="section" id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
<p>The output from this fit code is:</p>
<div class="highlight-python"><div class="highlight"><pre>============================== nterm = 2
Least Square Fit:
  chi2/dof [dof] = 0.98 [28]    Q = 0.49    logGBF = 481.95

Parameters:
            a 0    0.21854 (15)      [  0.0 (1.0) ]  
              1     0.2721 (46)      [  0.0 (1.0) ]  
        logdE 0   -0.87637 (28)      [ -0.7 (1.0) ]  
              1     -0.330 (12)      [ -0.7 (1.0) ]  

Settings:
  svdcut/n = 1e-15/0    reltol/abstol = 1e-10/1e-10    (itns/time = 15/0.0)

E   0.41629(11)      1.1354(83)     
a   0.21854(15)      0.2721(46)     

============================== nterm = 3
Least Square Fit:
  chi2/dof [dof] = 0.68 [28]    Q = 0.89    logGBF = 483.08

Parameters:
            a 0    0.21836 (18)      [  0.0 (1.0) ]  
              1       0.15 (12)      [  0.0 (1.0) ]  
              2      0.308 (51)      [  0.0 (1.0) ]  
        logdE 0   -0.87660 (30)      [ -0.7 (1.0) ]  
              1      -0.56 (28)      [ -0.7 (1.0) ]  
              2      -0.92 (53)      [ -0.7 (1.0) ]  

Settings:
  svdcut/n = 1e-15/0    reltol/abstol = 1e-10/1e-10    (itns/time = 25/0.1)

E   0.41620(12)      0.99(16)       
a   0.21836(18)      0.15(12)       

============================== nterm = 4
Least Square Fit:
  chi2/dof [dof] = 0.68 [28]    Q = 0.89    logGBF = 483.08

Parameters:
            a 0    0.21836 (18)      [  0.0 (1.0) ]  
              1       0.15 (12)      [  0.0 (1.0) ]  
              2      0.308 (51)      [  0.0 (1.0) ]  
              3      2e-07 +- 1      [  0.0 (1.0) ]  
        logdE 0   -0.87660 (30)      [ -0.7 (1.0) ]  
              1      -0.56 (28)      [ -0.7 (1.0) ]  
              2      -0.92 (53)      [ -0.7 (1.0) ]  
              3      -0.7 (1.0)      [ -0.7 (1.0) ]  

Settings:
  svdcut/n = 1e-15/0    reltol/abstol = 1e-10/1e-10    (itns/time = 13/0.1)

E   0.41620(12)      0.99(16)       
a   0.21836(18)      0.15(12)       

============================== nterm = 5
Least Square Fit:
  chi2/dof [dof] = 0.68 [28]    Q = 0.89    logGBF = 483.08

Parameters:
            a 0    0.21836 (18)      [  0.0 (1.0) ]  
              1       0.15 (12)      [  0.0 (1.0) ]  
              2      0.308 (51)      [  0.0 (1.0) ]  
              3      2e-07 +- 1      [  0.0 (1.0) ]  
              4     -3e-08 +- 1      [  0.0 (1.0) ]  
        logdE 0   -0.87660 (30)      [ -0.7 (1.0) ]  
              1      -0.56 (28)      [ -0.7 (1.0) ]  
              2      -0.92 (53)      [ -0.7 (1.0) ]  
              3      -0.7 (1.0)      [ -0.7 (1.0) ]  
              4      -0.7 (1.0)      [ -0.7 (1.0) ]  

Settings:
  svdcut/n = 1e-15/0    reltol/abstol = 1e-10/1e-10    (itns/time = 14/0.1)

E   0.41620(12)      0.99(16)       
a   0.21836(18)      0.15(12)       
</pre></div>
</div>
<p>These fits are very fast &#8212; a small fraction of a second each on a laptop.
Fit results converge by <tt class="docutils literal"><span class="pre">N=3</span></tt> states. The amplitudes and energy differences
for states above the first three are essentially identical to the prior
values; the Monte Carlo data are not sufficiently accurate to add any new
information about these levels. The fits for <tt class="docutils literal"><span class="pre">N&gt;=3</span></tt> are excellent, with
chi-square per degree of freedom (<tt class="docutils literal"><span class="pre">chi2/dof</span></tt>) of 0.68. There are only
28 degrees of freedom here because the fitter, taking advantage of the
periodicity, folded the data about the midpoint in <tt class="docutils literal"><span class="pre">t</span></tt> and averaged,
before fitting. The ground state energy and amplitude are determined to
a part in 1,000 or better.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Annotated Example: Two-Point Correlator</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#code">Code</a></li>
<li><a class="reference internal" href="#results">Results</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="corrfitter.html"
                        title="previous chapter"><tt class="docutils literal"><span class="pre">corrfitter</span></tt> - Least-Squares Fit to Correlators</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example-etas-Ds.html"
                        title="next chapter">Annotated Example: Transition Form Factor</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example-etas-Ds.html" title="Annotated Example: Transition Form Factor"
             >next</a> |</li>
        <li class="right" >
          <a href="corrfitter.html" title="corrfitter - Least-Squares Fit to Correlators"
             >previous</a> |</li>
        <li><a href="index.html">corrfitter 4.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010-14, G.P. Lepage.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>